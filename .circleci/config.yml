# Use the latest 2.1 version of CircleCI pipeline process engine
version: 2.1

# Define orbs to reuse functionality
orbs:
  node: circleci/node@7.2.1
  rust: circleci/rust@1.8.0

# Define jobs
jobs:
  validate-rust:
    docker:
      - image: cimg/rust:1.92.0
    resource_class: large
    steps:
      - checkout

      # Check formatting (runs first, fast feedback)
      - rust/format:
          with_cache: false

      # Run clippy, tests, and build with built-in caching
      - rust/clippy:
          with_cache: true
          cache_version: v1
          flags: "--all --all-targets -- -D warnings"

      - run:
          name: Run tests
          command: cargo test --verbose

      - run:
          name: Build release
          command: cargo build --release --verbose

  validate-react:
    docker:
      - image: cimg/node:lts
    resource_class: medium
    steps:
      - checkout

      # Install pnpm and dependencies with automatic caching
      - node/install-packages:
          pkg-manager: pnpm
          app-dir: src-ui
          with-cache: true
          cache-version: v1

      # Check code formatting
      - run:
          name: Check code formatting
          command: cd src-ui && npx prettier --check .

      # Run tests
      - run:
          name: Run tests
          command: cd src-ui && pnpm test -- --watchAll=false

      # Build frontend
      - run:
          name: Build frontend
          command: cd src-ui && pnpm run build

      # Persist static build for Docker job
      - persist_to_workspace:
          root: .
          paths:
            - static

  build-docker:
    docker:
      - image: cimg/base:current
    resource_class: medium
    steps:
      - checkout

      # Attach workspace to get frontend build
      - attach_workspace:
          at: .

      # Setup remote Docker with layer caching
      - setup_remote_docker:
          version: default
          docker_layer_caching: true

      # Build Docker image
      - run:
          name: Build Docker image
          command: make docker-build

# Orchestrate workflow
workflows:
  validate-and-build:
    jobs:
      - validate-rust
      - validate-react
      - build-docker:
          requires:
            - validate-rust
            - validate-react
          filters:
            branches:
              only: master  # Fixed: was 'main'